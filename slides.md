---
# You can also start simply with 'default'
theme: academic
# random image from a curated Unsplash collection by Anthony
# like them? see https://unsplash.com/collections/94734566/slidev
# background: https://cover.sli.dev
highlighter: shiki
# some information about your slides (markdown enabled)
title: 10-Linking
info: |
  ICS 2024 Fall Slides
  Presented by WalkerCH
titleTemplate: '%s'
# apply unocss classes to the current slide
class: text-center
# https://sli.dev/features/drawing
drawings:
  persist: false
# slide transition: https://sli.dev/guide/animations.html#slide-transitions
transition: fade-out
# enable MDC Syntax: https://sli.dev/features/mdc
mdc: true
layout: cover
coverBackgroundUrl: /res/image/cover/cover_10.jpg

---

# Processor Arch {.font-bold}

<p class="text-gray-100">
<font size = '5'>
  13 å…ƒåŸ¹æ•°ç§‘ å¸¸æ¬£æµ·
</font>
</p>

<div class="pt-12  text-gray-1">
  <span @click="$slidev.nav.next" class="px-2 py-1 rounded cursor-pointer" hover="bg-white bg-opacity-10">
    Here we go! <carbon:arrow-right class="inline"/>
  </span>
</div>


<div class="abs-br m-6 flex gap-2">
  <button @click="$slidev.nav.openInEditor()" title="Open in Editor" class="text-xl slidev-icon-btn opacity-50 !border-none !hover:text-white">
    <carbon:edit />
  </button>
  <a href="https://github.com/Yaenday/WalkerCH-ICS-Slides
  " target="_blank" alt="GitHub" title="Open in GitHub"
    class="text-xl slidev-icon-btn opacity-50 !border-none !hover:text-white">
    <carbon-logo-github />
  </a>
</div>

<style>
  div{
   @apply text-gray-2;
  }
</style>


---

# ç›®å½•

<Toc columns="4" minDepth="1"></Toc>


---
layout: center
---

<div style="text-align: center;">
  <text class="text-17 font-bold gradient-text">Knowledge Review</text>
  <br />
  <text class="text-5 font-bold">This part is cited from Arthals</text>
</div>


<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>

---

# é“¾æ¥

Linking

**é“¾æ¥**ï¼šå°†å¤šä¸ªç›®æ ‡æ–‡ä»¶ç»„åˆæˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚

**ç›®æ ‡æ–‡ä»¶**ï¼šç¼–è¯‘å™¨å°†æºä»£ç æ–‡ä»¶ç¼–è¯‘åçš„äº§ç‰©ï¼Œä½†è¿˜æœªé“¾æ¥æˆæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

**å¯æ‰§è¡Œæ–‡ä»¶**ï¼šé“¾æ¥åçš„æœ€ç»ˆäº§ç‰©ï¼Œè¿™ä¸ªæ–‡ä»¶å¯è¢«åŠ è½½ï¼ˆå¤åˆ¶ï¼‰åˆ°å†…å­˜å¹¶æ‰§è¡Œã€‚

é“¾æ¥åœ¨ **ç¼–è¯‘æ—¶ã€åŠ è½½æ—¶ã€è¿è¡Œæ—¶** å‡å¯æ‰§è¡Œï¼ˆåæ–‡ä¼šè¯´éƒ½æ˜¯å•¥ï¼‰ã€‚

é“¾æ¥çš„ä¼˜åŠ¿ï¼š

- **ä»£ç æ¨¡å—åŒ–**ï¼šæ–¹ä¾¿æŸ¥æ‰¾é—®é¢˜ä¸ç»´æŠ¤ï¼Œå¯ä»¥å»ºç«‹å¸¸è§å‡½æ•°çš„åº“
- **æ—¶é—´å’Œç©ºé—´æ•ˆç‡**ï¼šåªéœ€è¦æ”¹ä¸€å¤„ä»£ç å¯åŒæ—¶å½±å“å¤šä¸ªä»£ç ï¼Œåªä¼šç¼–è¯‘ä½ å¼•ç”¨çš„åº“ä¸­ç”¨åˆ°çš„ä»£ç 


<!-- 

è¿™ç« ç¡®å®ç¿»è¯‘çš„ä¸€å¨ï¼Œçœ‹ä¹¦ä½“éªŒå¾ˆå·®ã€‚

 -->

---

# ä»æºä»£ç åˆ°å¯æ‰§è¡Œæ–‡ä»¶

From source code to executable file

![compile_system](./res/image/slides.assets/compile_system.png)

$$
\text{.c} \xrightarrow{\text{cpp}} \text{.i} \xrightarrow{\text{cc1}} \text{.s} \xrightarrow{\text{as}} \text{.o} \xrightarrow{\text{ld}} \text{prog}
$$

<div class="text-sm">

<v-clicks>


- `gcc`ï¼šç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº
- `cpp`ï¼šC é¢„å¤„ç†ï¼ˆc preprocessorï¼‰ï¼Œå°† xx.c ç¿»è¯‘æˆä¸€ä¸ª ASCII ç çš„ **ä¸­é—´æ–‡ä»¶**{.text-sky-5} xx.iï¼ˆintermediate fileï¼‰
- `cc1`ï¼šC ç¼–è¯‘å™¨ï¼ˆc compilerï¼‰ï¼Œå°† xx.i ç¿»è¯‘æˆä¸€ä¸ª ASCII **æ±‡ç¼–è¯­è¨€æ–‡ä»¶**{.text-sky-5} xx.sï¼ˆassembly language fileï¼‰
- `as`ï¼šæ±‡ç¼–å™¨ï¼ˆassemblerï¼‰ï¼Œå°† xx.s ç¿»è¯‘æˆä¸€ä¸ª **å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶**{.text-sky-5} xx.oï¼ˆrelocatable object fileï¼‰
- `ld`ï¼šé“¾æ¥å™¨ï¼ˆlinkerï¼‰ï¼Œå°† xx.o å’Œå…¶ä»–çš„ xx.oï¼Œä»¥åŠå¿…è¦çš„ç³»ç»Ÿç›®æ ‡æ–‡ä»¶ç»„åˆèµ·æ¥ï¼Œåˆ›å»ºä¸€ä¸ª**å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶**{.text-sky-5} prog

</v-clicks>

<span class="text-sm text-gray-5">

\* ä¹¦ 1.2 ç« ï¼ŒçŸ¥é“å¤§å®¶éƒ½æ²¡çœ‹ï¼Œå¯ä»¥å›å»çœ‹ã€‚

</span>


</div>


---

# é™æ€é“¾æ¥

Static Linking

<div grid="~ cols-2 gap-12">
<div>

### main.c
```c
int sum(int *a, int n);  // è¿™é‡Œå£°æ˜äº†å‡½æ•°ï¼Œä½†æœªå®šä¹‰
int array[2] = {1, 2};  

int main()  
{  
    int val = sum(array, 2);  
    return val;  
}
```

### sum.c
```c
int sum(int *a, int n)   // è¿™é‡Œå®šä¹‰äº†å‡½æ•°
{  
    int i, s = 0;  
    for (i = 0; i < n; i++) {  
        s += a[i];  
    }  
    return s;  
}
```

</div>

<div flex="~ col gap-4 justify-center items-center">

![compile_system](./res/image/slides.assets/compile_system.png)

![static_linking](./res/image/slides.assets/static_linking.png){.h-60}

</div>
</div>

---

# é™æ€é“¾æ¥

Static Linking

åœ¨é™æ€é“¾æ¥ä¸­ï¼Œé“¾æ¥å™¨éœ€è¦å®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š

- **ç¬¦å·è§£æ**{.text-sky-5}ï¼šå°† **ç¬¦å·å¼•ç”¨** ä¸è¾“å…¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ä¸­çš„ **ç¬¦å·è¡¨** ä¸­çš„ä¸€ä¸ªç¡®å®šçš„ç¬¦å·ï¼ˆå…¨å±€å˜é‡ã€å‡½æ•°ç­‰ï¼‰å…³è”èµ·æ¥ã€‚
- **é‡å®šä½**{.text-sky-5}ï¼š**åˆå¹¶é‡å®šä½è¾“å…¥æ¨¡å—**ï¼Œå°†ç¬¦å·å®šä¹‰ä¸ä¸€ä¸ªåœ°å€å…³è”èµ·æ¥ï¼Œå¹¶ä¸ºæ‰¾åˆ°çš„æ¯ä¸ªç¬¦å·æŒ‡å‘å¯¹åº”çš„è¯¥åœ°å€ã€‚

---

# ç›®æ ‡æ–‡ä»¶

Object File

1. **å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶**
   - è¿™æ˜¯ä¸€ä¸ªåŒ…å«è®¡ç®—æœºèƒ½ç›´æ¥ç†è§£çš„ä»£ç å’Œæ•°æ®çš„æ–‡ä»¶ï¼Œ**ä½†å®ƒè¿˜ä¸èƒ½å•ç‹¬è¿è¡Œ**{.text-sky-5}ã€‚
   - å®ƒå°±åƒæ˜¯ä¸€ä¸ªåŠæˆå“ï¼Œéœ€è¦å’Œå…¶ä»–åŠæˆå“åˆå¹¶åœ¨ä¸€èµ·æ‰èƒ½å˜æˆä¸€ä¸ªå®Œæ•´çš„äº§å“ã€‚
2. **å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶**
   - è¿™æ˜¯ä¸€ä¸ªå·²ç»å‡†å¤‡å¥½ **å¯ä»¥ç›´æ¥åœ¨è®¡ç®—æœºä¸Šè¿è¡Œçš„æ–‡ä»¶**{.text-sky-5}ã€‚
   - å®ƒå°±åƒæ˜¯ä¸€ä¸ªå·²ç»ç»„è£…å¥½çš„ç©å…·ï¼Œæ‹¿åˆ°æ‰‹å°±å¯ä»¥ç©äº†ï¼Œä¸éœ€è¦å†åšå…¶ä»–æ“ä½œã€‚
3. **å…±äº«ç›®æ ‡æ–‡ä»¶**
   - **ç‰¹æ®Šç±»å‹çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶**{.text-sky-5}ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™ **åŠ¨æ€åŠ è½½**{.text-sky-5} è¿›æ¥ä½¿ç”¨ã€‚
   - å®ƒå°±åƒæ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™è£…ä¸Šå»ï¼Œä¸éœ€è¦çš„æ—¶å€™å¯ä»¥å–ä¸‹æ¥ã€‚

---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

Relocatable Object File

<div grid="~ cols-2 gap-12">
<div>

```
ELF å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶
â”‚
â”œâ”€â”€ ELF å¤´ï¼ˆELF Headerï¼‰[ä½åœ°å€]
â”‚
â”œâ”€â”€ èŠ‚ï¼ˆSectionsï¼‰
â”‚   â”œâ”€â”€ .textï¼ˆæœºå™¨ä»£ç ï¼‰
â”‚   â”œâ”€â”€ .rodataï¼ˆåªè¯»æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ .dataï¼ˆå·²åˆå§‹åŒ–æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ .bssï¼ˆæœªåˆå§‹åŒ–æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ .symtabï¼ˆç¬¦å·è¡¨ï¼‰
â”‚   â”œâ”€â”€ .rel.textï¼ˆé‡å®šä½ä¿¡æ¯ï¼‰
â”‚   â”œâ”€â”€ .rel.dataï¼ˆé‡å®šä½ä¿¡æ¯ï¼‰
â”‚   â”œâ”€â”€ .debugï¼ˆè°ƒè¯•ä¿¡æ¯ï¼‰
â”‚   â””â”€â”€ .strtabï¼ˆå­—ç¬¦ä¸²è¡¨ï¼‰
â”‚
â”œâ”€â”€ èŠ‚å¤´éƒ¨è¡¨ï¼ˆSection Header Tableï¼‰[é«˜åœ°å€]
â”‚   â”œâ”€â”€ èŠ‚å¤´éƒ¨æ¡ç›® 1
â”‚   â”œâ”€â”€ èŠ‚å¤´éƒ¨æ¡ç›® 2
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ èŠ‚å¤´éƒ¨æ¡ç›® N
```

</div>

<div>


![relocatable_object_file](./res/image/slides.assets/relocatable_object_file.png)

</div>
</div>

---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

Relocatable Object File

<div grid="~ cols-2 gap-12">
<div>

### ELF å¤´

å­˜å‚¨å…³äºè¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸€èˆ¬ä¿¡æ¯ï¼š

æ–‡ä»¶çš„ç±»å‹ã€å­—èŠ‚åºã€ELF å¤´é•¿åº¦ã€èŠ‚å¤´éƒ¨è¡¨åç§»é‡ã€èŠ‚å¤´éƒ¨è¡¨æ¡ç›®å¤§å°å’Œæ•°é‡ç­‰ä¿¡æ¯ã€‚

è¿è¡Œæ—¶ï¼Œä¼šæ ¹æ®è¿™äº›ä¿¡æ¯ï¼š

1. å…ˆå®šä½åˆ° ELF å¤´
2. ç„¶åæ ¹æ® ELF å¤´ä¸­çš„ä¿¡æ¯æ‰¾åˆ°èŠ‚å¤´éƒ¨è¡¨
3. å†æ ¹æ®èŠ‚å¤´éƒ¨è¡¨æ‰¾åˆ°ç›¸åº”çš„èŠ‚

</div>

<div>


![relocatable_object_file](./res/image/slides.assets/relocatable_object_file.png)

</div>
</div>

---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

Relocatable Object File

<div grid="~ cols-2 gap-12">
<div>

### èŠ‚


`.text`ï¼šå·²ç¼–è¯‘ç¨‹åºçš„æœºå™¨ä»£ç 

`.rodata`ï¼šåªè¯»<span class="text-sm text-gray-5">ï¼ˆread-onlyï¼‰</span>æ•°æ®ï¼Œå¦‚ `printf` ä¸­çš„æ ¼å¼ä¸²ã€å¼€å…³è¯­å¥çš„è·³è½¬è¡¨ã€å­—ç¬¦ä¸²å¸¸é‡ç­‰

`.data`ï¼š<span text-sky-5> å·²åˆå§‹åŒ–çš„å…¨å±€ä¸é™æ€ C å˜é‡</span>

`.bss`ï¼š<span text-sky-5> æœªåˆå§‹åŒ–çš„å…¨å±€å’Œé™æ€ C å˜é‡ï¼Œä»¥åŠæ‰€æœ‰è¢«åˆå§‹åŒ–ä¸º 0 çš„å…¨å±€å’Œé™æ€ C å˜é‡</span><br><span class="text-sm text-gray-5">ï¼ˆBlock Storage Start / Better Save Spaceï¼‰</span>

<span class="text-sm text-gray-5">

\* å°†åˆå§‹åŒ–ä¸º 0 çš„å˜é‡æ”¾åœ¨ `.bss` æ®µè€Œä¸æ˜¯ `.data` æ®µï¼Œå¯ä»¥ä½¿å¯æ‰§è¡Œæ–‡ä»¶æ›´å°ï¼Œå› ä¸º `.bss` æ®µåªéœ€è¦è®°å½•å˜é‡çš„å¤§å°å’Œä½ç½®ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å®é™…çš„ 0 å€¼ï¼ˆç›´åˆ°è¿è¡Œæ—¶æ‰çœŸçš„å»å†…å­˜ä¸­åˆ†é…ç©ºé—´ï¼‰ã€‚

</span>

</div>


<div>


![relocatable_object_file](./res/image/slides.assets/relocatable_object_file.png)

</div>
</div>

---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

Relocatable Object File

<div grid="~ cols-2 gap-12">
<div>

### èŠ‚


`.symtab`ï¼šç¬¦å·è¡¨ <span class="text-sm text-gray-5">ï¼ˆsymbol tableï¼‰</span>ï¼Œå­˜æ”¾å®šä¹‰å’Œå¼•ç”¨çš„å‡½æ•°ä¸å…¨å±€å˜é‡ä¿¡æ¯

`.rel.text`ï¼šé‡å®šä½ä¿¡æ¯ <span class="text-sm text-gray-5">ï¼ˆrelocate textï¼‰</span>

`.rel.data`ï¼šé‡å®šä½ä¿¡æ¯ <span class="text-sm text-gray-5">ï¼ˆrelocate dataï¼‰</span>ï¼Œï¼ˆæœªåˆå§‹åŒ–æˆ–ä¸º 0 çš„å˜é‡ä¸éœ€è¦é‡å®šä½ï¼‰

`.strtab`ï¼šå­—ç¬¦ä¸²è¡¨ <span class="text-sm text-gray-5">ï¼ˆstring tableï¼‰</span> ï¼ŒåŒ…æ‹¬ï¼š 

<span class="text-sm text-gray-5">

- `.symtab` å’Œ `.debug` èŠ‚ä¸­çš„ç¬¦å·è¡¨
- èŠ‚å¤´éƒ¨ä¸­çš„èŠ‚åå­—

å­—ç¬¦ä¸²è¡¨å°±æ˜¯ä»¥ nullï¼ˆ`\0`ï¼‰ç»“å°¾çš„å­—ç¬¦ä¸²çš„åºåˆ—ã€‚

</span>


</div>


<div>


![relocatable_object_file](./res/image/slides.assets/relocatable_object_file.png)

</div>
</div>

<!-- 

è¿˜æœ‰ `.debug` èŠ‚ï¼Œå­˜å‚¨è°ƒè¯•ä¿¡æ¯ã€‚`.line` èŠ‚ï¼Œå­˜å‚¨è¡Œå·ä¿¡æ¯ã€‚

-->

---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

Relocatable Object File

<div grid="~ cols-2 gap-12">
<div>

### èŠ‚å¤´éƒ¨è¡¨

å­˜å‚¨ä¸åŒéƒ¨åˆ†çš„èµ·å§‹ä½ç½®ã€‚

</div>

<div>

![relocatable_object_file](./res/image/slides.assets/relocatable_object_file.png)

</div>
</div>


---

# ç¬¦å·å’Œç¬¦å·è¡¨

Symbols and Symbol Table

æ¯ä¸ªå¯é‡å®šä½ç›®æ ‡æ¨¡å— $m$ éƒ½æœ‰ä¸€ä¸ªç¬¦å·è¡¨ï¼ŒåŒ…å«ç¬¦å·çš„å®šä¹‰å’Œå¼•ç”¨è¯¦æƒ…ï¼Œå®ƒä»¬åŒ…æ‹¬ï¼š

- **å…¨å±€ç¬¦å·**ï¼š$m$ å®šä¹‰å¹¶èƒ½è¢«å…¶ä»–æ¨¡å— $n$ å¼•ç”¨çš„ï¼Œå¯¹åº”éé™æ€çš„ C å‡½æ•°å’Œå…¨å±€å˜é‡ã€‚
- **å±€éƒ¨ç¬¦å·**ï¼š$m$ å®šä¹‰ä¸” **åª**{.text-sky-5} åœ¨æ¨¡å— $m$ å†…è‡ªå·±ä½¿ç”¨çš„ï¼Œå¯¹åº”å¸¦ `static` å±æ€§çš„ C å‡½æ•°å’Œå…¨å±€å˜é‡ï¼Œè¿™äº›ç¬¦å·åœ¨æ¨¡å— $m$ å†…ä»»ä½•ä½ç½®éƒ½å¯è§ã€‚
- **å¤–éƒ¨ç¬¦å·**ï¼š$m$ å¼•ç”¨ä½† $m$ ä¸­ **æœªå®šä¹‰**{.text-sky-5} çš„ï¼Œå¯¹åº”å…¶ä»–æ¨¡å— $n$ å®šä¹‰çš„å‡½æ•°æˆ–å…¨å±€å˜é‡ã€‚

ç¬¦å·è¡¨ **ä¸å…³å¿ƒæœ¬åœ°éé™æ€ç¨‹åºå˜é‡**ï¼Œå¦‚ï¼š

```c{2}
int main() {
    int a = 1;
    return 0;
}
```

è¿™é‡Œçš„ `a` æ˜¯å±€éƒ¨å˜é‡ï¼Œä¸ä¼šå‡ºç°åœ¨ç¬¦å·è¡¨ä¸­ï¼Œè€Œæ˜¯å‡ºç°åœ¨æ ˆä¸­ã€‚

<button @click="$nav.go(14)">ğŸ”™</button>


---

# Static å±æ€§

`static` Attribute

`static` å®šä¹‰çš„å‡½æ•°å’Œå…¨å±€å˜é‡ **åªèƒ½åœ¨å…¶å£°æ˜æ¨¡å—ä¸­ä½¿ç”¨ï¼ˆç±»ä¼¼ C++ çš„ `private`ï¼‰**{.text-sky-5}ï¼Œå¯¹å…¶ä»–æ¨¡å—ä¸å¯è§ã€‚

ç¼–è¯‘å™¨ä¼šåœ¨ `.data` æˆ– `.bss` ä¸­ä¸ºå…¶åˆ†é…ç©ºé—´ï¼Œåˆ›é€ ä¸€ä¸ªå…·æœ‰å”¯ä¸€åå­—çš„ç¬¦å·ã€‚

<div grid="~ cols-2 gap-12">
<div text-sm>

åœ¨å³ä¾§ä»£ç ä¸­ï¼š

- å¸¦æœ‰ `static` å…³é”®å­—çš„å˜é‡ä¼šå‡ºç°åœ¨ç¬¦å·è¡¨ä¸­ï¼Œä¸”åœ¨ `.data` æˆ– `.bss` ä¸­åˆ†é…ç©ºé—´
- æœªå¸¦æœ‰ `static` å…³é”®å­—çš„å˜é‡ä¸ä¼šå‡ºç°åœ¨ç¬¦å·è¡¨ä¸­ï¼Œè€Œæ˜¯å‡ºç°åœ¨æ ˆä¸­
- ç”±äºå‡ºç°äº†é‡åçš„ `static` å˜é‡ï¼Œç¼–è¯‘å™¨ç”Ÿæˆä¸åŒåç§°çš„å±€éƒ¨é“¾æ¥å™¨ç¬¦å·ï¼Œå¦‚ `x.1` è¡¨ç¤ºå‡½æ•° `f` ä¸­çš„é™æ€å˜é‡ï¼Œè€Œ `x.2` è¡¨ç¤ºå‡½æ•° `g` ä¸­çš„é™æ€å˜é‡


</div>

<div>


```c
int f() {
    static int x = 0;
    int y = 1;
    return x + y;
}

int g() {
    static int x = 1;
    int y = 2;
    return x + y;
}
```

</div>
</div>

---

# ç¬¦å·è¡¨ç»“æ„

Symbol Table Structure

<div grid="~ cols-2 gap-12">
<div text-sm>

- `name`ï¼šæŒ‡å‘ç¬¦å·çš„ nullï¼ˆ`\0`ï¼‰ ç»“æŸçš„å­—ç¬¦ä¸²åå­—
- `value`
  - å¯¹äºå¯é‡å®šä½çš„æ¨¡å—æ¥è¯´ï¼Œè¡¨ç¤ºç›¸å¯¹äºå®šä¹‰æ‰€åœ¨èŠ‚ï¼ˆ`section`ï¼‰èµ·å§‹ä½ç½®çš„åç§»
  - å¯¹äºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶æ¥è¯´ï¼Œè¯¥å€¼æ˜¯ä¸€ä¸ªç»å¯¹è¿è¡Œæ—¶åœ°å€
- `size`ï¼šç›®æ ‡çš„å¤§å°ï¼ˆå­—èŠ‚ä¸ºå•ä½ï¼‰
- `type`ï¼šç¬¦å·ç±»å‹ï¼ˆå‡½æ•°æˆ–æ•°æ®ï¼‰
- `binding`ï¼šç¬¦å·æ˜¯å¦æ˜¯æœ¬åœ°çš„è¿˜æ˜¯å…¨å±€çš„ï¼ˆæ˜¯å¦å¯ä»¥è¢«å…¶ä»–æ¨¡å—å¼•ç”¨ï¼Œå³æœ‰æ—  `static` å…³é”®å­—ï¼‰<button @click="$nav.go(12)">ğŸ’¡</button>
- `section`ï¼šç¬¦å·æ‰€åœ¨çš„èŠ‚

</div>

<div>

```c
typedef struct {
    int name;        // .strtab ä¸­çš„åç§»
    char type:4,     // å‡½æ•°æˆ–æ•°æ®
         binding:4;  // å±€éƒ¨æˆ–å…¨å±€
    char reserved;   // æ˜¯å¦ä½¿ç”¨
    short section;   // èŠ‚å¤´éƒ¨è¡¨ç´¢å¼•
    long value;      // èŠ‚å†…åç§»æˆ–ç»å¯¹åœ°å€
    long size;       // å¯¹è±¡å¤§å°ï¼ˆå­—èŠ‚ï¼‰
} Elf64_Symbol;
```

</div>
</div>

---

# ç¬¦å·è¡¨æ¡ç›®åˆ†é…

Allocation of Symbol Table Entries

æ¯ä¸ªç¬¦å·å°†è¢«åˆ†é…åˆ°ç›®æ ‡æ–‡ä»¶çš„æŸä¸ªèŠ‚ï¼ˆsectionï¼‰ï¼Œå¦‚ `.text` `.data` `.bss` ç­‰ã€‚

æœ‰ä¸‰ä¸ªç‰¹æ®Šçš„ä¼ªèŠ‚ï¼ˆpseudosectionï¼‰ï¼Œå®ƒä»¬åœ¨èŠ‚å¤´éƒ¨è¡¨ä¸­æ˜¯æ²¡æœ‰æ¡ç›®çš„ï¼š

- `ABS`ï¼šä»£è¡¨ä¸è¯¥è¢«é‡å®šä½çš„ç¬¦å·ï¼ˆabsoluteï¼‰
- `UNDEF`ï¼šä»£è¡¨æœªå®šä¹‰çš„ç¬¦å·ï¼ˆundefinedï¼‰
- `COMMON`ï¼šæœªè¢«åˆ†é…ä½ç½®çš„æœªåˆå§‹åŒ–çš„æ•°æ®ç›®æ ‡

`COMMON` vs `.bss`ï¼š

- `COMMON`ï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œ**ä»è€Œå®ƒä»¬å¯èƒ½å®šä¹‰åœ¨å…¶ä»–æ¨¡å—ä¸­**{.text-sky-5}
- `.bss`ï¼šæœªåˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œä»¥åŠåˆå§‹åŒ–ä¸º 0 çš„å…¨å±€æˆ–é™æ€å˜é‡ï¼Œ**å¿…ç„¶å®šä¹‰åœ¨å½“å‰æ¨¡å—ä¸­**{.text-sky-5}

<br>

```c
int a; // æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œå±äº COMMON
static int b; // æœªè¢«åˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œå±äº .bss
```


---
clicks: 5
---

# ç¬¦å·è¡¨æ¡ç›®åˆ†é…

Allocation of Symbol Table Entries

<div class="text-sm">

å¯¹äº `m.o` å’Œ `swap.o` æ¨¡å—ï¼Œå¯¹æ¯ä¸ªç¬¦å·åœ¨ `swap.o` ä¸­å®šä¹‰æˆ–å¼•ç”¨çš„ç¬¦å·ï¼ŒæŒ‡å‡ºæ˜¯å¦åœ¨ **æ¨¡å— `swap.o` çš„ `.symtab` èŠ‚**{.text-sky-5} ä¸­æœ‰ä¸€ä¸ªç¬¦å·æ¡ç›®ã€‚å¦‚æœæ˜¯ï¼Œè¯·æŒ‡å‡ºè¯¥ç¬¦å·çš„æ¨¡å—ï¼ˆ`swap.o` æˆ–è€… `m.o`ï¼‰ã€ç¬¦å·ç±»å‹ï¼ˆå±€éƒ¨ã€å…¨å±€æˆ–è€…å¤–éƒ¨ï¼‰ä»¥åŠå®ƒåœ¨æ¨¡å—ä¸­è¢«åˆ†é…åˆ°çš„èŠ‚ï¼ˆ`.text`ã€`.data`ã€`.bss` æˆ– `COMMON`ï¼‰ã€‚

<div grid="~ cols-2 gap-4">
<div grid="~ cols-2 gap-4">
<div>

```c
// m.c
void swap();
int buf[2] = {1, 2};

int main() 
{
    swap();
    return 0;
}
```

</div>

<div>

```c
// swap.c
extern int buf [];

int *bufp0 = &buf[0];
int *bufp1;

void swap(){
  int temp;

  bufp1 = &buf[1];
  temp = *bufp0;
  *bufp0 = *bufp1;
  *bufp1 = temp;
}
```

</div>
</div>

<div text-xs>

<div :class="$clicks>0 ? 'hidden' : ''">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚  |
| ----- | :-----------: | -------- | ---------------- | --- |
| buf   |               |          |                  |     |
| bufp0 |               |          |                  |     |
| bufp1 |               |          |                  |     |
| swap  |               |          |                  |     |
| temp  |               |          |                  |     |

</div>
<div :class="$clicks==1 ? '' : 'hidden'">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚   |
| ----- | :-----------: | -------- | ---------------- | ---- |
| buf   |       âœ”       | å…¨å±€     | m.o              | .bss |
| bufp0 |               |          |                  |      |
| bufp1 |               |          |                  |      |
| swap  |               |          |                  |      |
| temp  |               |          |                  |      |


</div>
<div :class="$clicks==2 ? '' : 'hidden'">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚    |
| ----- | :-----------: | -------- | ---------------- | ----- |
| buf   |       âœ”       | å…¨å±€     | m.o              | .bss  |
| bufp0 |       âœ”       | å…¨å±€     | swap.o           | .data |
| bufp1 |               |          |                  |       |
| swap  |               |          |                  |       |
| temp  |               |          |                  |       |


</div>
<div :class="$clicks==3 ? '' : 'hidden'">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚     |
| ----- | :-----------: | -------- | ---------------- | ------ |
| buf   |       âœ”       | å…¨å±€     | m.o              | .bss   |
| bufp0 |       âœ”       | å…¨å±€     | swap.o           | .data  |
| bufp1 |       âœ”       | å…¨å±€     | swap.o           | COMMON |
| swap  |               |          |                  |        |
| temp  |               |          |                  |        |


</div>
<div :class="$clicks==4 ? '' : 'hidden'">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚     |
| ----- | :-----------: | -------- | ---------------- | ------ |
| buf   |       âœ”       | å…¨å±€     | m.o              | .bss   |
| bufp0 |       âœ”       | å…¨å±€     | swap.o           | .data  |
| bufp1 |       âœ”       | å…¨å±€     | swap.o           | COMMON |
| swap  |       âœ”       | å…¨å±€     | swap.o           | .text  |
| temp  |               |          |                  |        |


</div>
<div :class="$clicks==5 ? '' : 'hidden'">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚     |
| ----- | :-----------: | -------- | ---------------- | ------ |
| buf   |       âœ”       | å…¨å±€     | m.o              | .bss   |
| bufp0 |       âœ”       | å…¨å±€     | swap.o           | .data  |
| bufp1 |       âœ”       | å…¨å±€     | swap.o           | COMMON |
| swap  |       âœ”       | å…¨å±€     | swap.o           | .text  |
| temp  |       âœ˜       | å±€éƒ¨     | swap.o           |        |


</div>
</div>
</div>
</div>

---

# ç¬¦å·è§£æ

Symbol Resolution

ç¬¦å·è§£æï¼šåœ¨å¤šä¸ªæ¨¡å—é—´ï¼Œå°†æ¯ä¸ªå¼•ç”¨ä¸ä¸€ä¸ªç¡®å®šçš„ç¬¦å·å®šä¹‰å…³è”èµ·æ¥ã€‚

é“¾æ¥æ—¶ï¼Œå°†ç¼–è¯‘å™¨è¾“å‡ºçš„å…¨å±€ç¬¦å·åˆ†ä¸ºï¼š

- **å¼ºç¬¦å·**{.text-sky-5}ï¼šåŒ…å«å‡½æ•°å’Œå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡
- **å¼±ç¬¦å·**{.text-sky-5}ï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡

é€‰æ‹©è§„åˆ™ï¼š

1. ä¸å…è®¸æœ‰å¤šä¸ªåŒåçš„å¼ºç¬¦å·
2. å¦‚æœæœ‰ä¸€ä¸ªå¼ºç¬¦å·å’Œå¤šä¸ªå¼±ç¬¦å·åŒåï¼Œåˆ™é€‰æ‹©å¼ºç¬¦å·
3. å¦‚æœæœ‰å¤šä¸ªå¼±ç¬¦å·åŒåï¼Œåˆ™ä»è¿™äº›å¼±ç¬¦å·ä¸­ä»»æ„é€‰æ‹©ä¸€ä¸ªï¼ˆä¸€èˆ¬é€‰æ‹©ç¬¬ä¸€ä¸ªï¼‰

å¤šä¸ªå…¨å±€ç¬¦å·åŒåçš„æ—¶å€™ï¼Œå³ä½¿ä¸è¿èƒŒä¸Šè¿°è§„åˆ™ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šå¯¼è‡´æ½œåœ¨é—®é¢˜ï¼šç±»å‹æ··æ·†ã€é¢„æœŸä»¥å¤–çš„ä½œç”¨ç­‰ã€‚

ä¸ºäº†å®‰å…¨ï¼Œå°½é‡ä½¿ç”¨ `static` å±æ€§å®šä¹‰å…¨å±€å˜é‡ã€‚

---

# ç¬¦å·è§£æçš„é—®é¢˜

Symbol Resolution Problems

<div grid="~ cols-3 gap-4">
<div>

### Case 1

```c
// foo1.c
int main()
{
    return 0;
}

// bar1.c
int main() // é‡å¤å®šä¹‰å¼ºç¬¦å·
{
    return 0;
}
```

</div>

<div>

### Case 2

```c
// foo2.c
int x = 15213;
int main()
{
    return 0;
}

// bar2.c
int x = 15213; // é‡å¤å®šä¹‰å¼ºç¬¦å·
int f()
{
    return 0;
}
```


</div>

<div>

### Case 3

```c
// foo3.c
#include <stdio.h>
void f(void);
int x = 15213;
int main()
{
    f(); // ä¼šä¿®æ”¹ x çš„å€¼
    printf("x = %d\n", x);
    return 0;
}

// bar3.c
int x;
void f()
{
    x = 15212;
}
```

</div>
</div>

---

# ç¬¦å·è§£æçš„é—®é¢˜

Symbol Resolution Problems

### Case 4

<div grid="~ cols-3 gap-8">
<div>


```c
// foo4.c
#include <stdio.h>
void f(void);

int y = 15212; // é«˜åœ°å€
int x = 15213; // ä½åœ°å€

int main()
{
    f();
    printf("x = 0x%x y = 0x%x\n",
            x, y);
    // 0x0 0x80000000
    return 0;
}
```

</div>

<div>

```c
// bar4.c
double x;

void f()
{
    x = -0.0;
}
```

</div>

<div>

`x` ä¼šæŒ‰ç…§ `double`ï¼ˆ8 å­—èŠ‚ï¼‰çš„æ–¹å¼è®¡ç®—ï¼Œä½†å®é™…ä¸Š `x` åªå ç”¨ 4 ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼ˆå› ä¸ºå®ƒæ˜¯ `int` ç±»å‹ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´å¯¹å†…å­˜çš„éæ³•è®¿é—®ã€‚

</div>
</div>



---

# é™æ€åº“

Static Libraries

**é™æ€åº“ï¼ˆStatic Libraryï¼‰**ï¼šæ˜¯ä¸€ç»„ç›®æ ‡æ–‡ä»¶çš„é›†åˆï¼Œé€šè¿‡å°†è¿™äº›ç›®æ ‡æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶æ¥å®ç°ä»£ç çš„é‡ç”¨ã€‚é™æ€åº“åœ¨ç¼–è¯‘æ—¶é“¾æ¥åˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰ä»£ç çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

### Why é™æ€åº“ï¼Ÿ{.mb-4}

1. åŒºåˆ†æ ‡å‡†å‡½æ•° / ç¨‹åºå‡½æ•°ï¼šå¤æ‚ 
2. æ‰€æœ‰æ ‡å‡†å‡½æ•°æ”¾ä¸€èµ·ï¼Œå­˜ä¸ºå•ç‹¬çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼šæ–‡ä»¶ä½“ç§¯å¤ªå¤§ï¼Œç»´æŠ¤è¦é‡æ–°æ‰“åŒ…
3. æ¯ä¸ªå‡½æ•°ä¸€ä¸ªæ¨¡å—ï¼šæ–‡ä»¶å¤šã€ç»´æŠ¤å¤æ‚ï¼Œæ‰‹åŠ¨æŒ‡å®šé“¾æ¥ç´¯æ­»äº†
4. ç›¸å…³çš„å‡½æ•°æ‰æ”¾åœ¨ä¸€èµ·ï¼šâœ”âœ”âœ”

---

# é™æ€åº“çš„åˆ›å»ºå’Œä½¿ç”¨

Creating and Using Static Libraries

<div grid="~ cols-2 gap-8">
<div>



### åˆ›å»ºé™æ€åº“{.my-2}

1. ç¼–è¯‘æºæ–‡ä»¶ç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼ˆ.oæ–‡ä»¶ï¼Œobject fileï¼‰ã€‚
    ```bash
    gcc -c addvec.c multvec.c # -c åªç¼–è¯‘ï¼Œä¸é“¾æ¥
    ```
2. ä½¿ç”¨ `ar`ï¼ˆarchiveï¼‰å·¥å…·å°†ç›®æ ‡æ–‡ä»¶æ‰“åŒ…æˆé™æ€åº“ï¼š
    ```bash
    ar rcs libvector.a addvec.o multvec.o
    ```
</div>

<div>


### ä½¿ç”¨é™æ€åº“{.my-2}

1. ç¼–è¯‘ä½¿ç”¨é™æ€åº“çš„ç¨‹åºæ–‡ä»¶ã€‚
    ```bash
    gcc -c main2.c
    ```
2. é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæŒ‡å®šé™æ€åº“çš„ä½ç½®ã€‚
    ```bash
    gcc -static -o prog2c main2.o ./libvector.a
    ```
    `-static`ï¼šæŒ‡å®šé™æ€é“¾æ¥ï¼Œæ— éœ€è¿è¡Œæ—¶é“¾æ¥<br>
    æˆ–è€…ä½¿ç”¨ `-L` å’Œ `-l` å‚æ•°ï¼ˆlibraryï¼‰ï¼š
    ```bash
    gcc -static -o prog2c main2.o -L. -lvector
    ```

</div>
</div>

---

# è§£æé™æ€åº“å¼•ç”¨

Resolving Static Library References

å¯¹äºä¸€è¡Œä»£ç ï¼Œé“¾æ¥å™¨ä»å·¦åˆ°å³æŒ‰éœ€è§£æåº“ä¸­çš„ç¬¦å·ï¼š

```bash
gcc foo.c libx.a liby.a libx.a
```

é›†åˆå®šä¹‰ï¼š

- $E$ï¼šæœ€ç»ˆæ‰€éœ€è¦çš„æˆå‘˜ç›®æ ‡æ–‡ä»¶ï¼ˆExportedï¼‰ï¼Œç›®æ ‡æ–‡ä»¶è‚¯å®šä¸¢è¿›å»ï¼Œå­˜æ¡£æ–‡ä»¶çœ‹æœ‰æ²¡æœ‰ç”¨ä¸Šå†å†³å®šã€‚
- $U$ï¼šæœªè§£æçš„ç¬¦å·ï¼ˆUndefinedï¼‰ï¼Œæ²¡å®šä¹‰çš„ç¬¦å·å°±å…ˆåŠ è¿›å»ï¼Œé‡åˆ°å­˜æ¡£æ–‡ä»¶å†çœ‹èƒ½ä¸èƒ½åŒ¹é…ä¸Šã€‚
- $D$ï¼šå·²å®šä¹‰çš„ç¬¦å·ï¼ˆDefinedï¼‰ï¼Œå·²ç»åŒ¹é…ä¸Šã€æ‰¾åˆ°å®šä¹‰çš„ç¬¦å·ã€‚

è§£æå®Œæˆåï¼Œä¸åœ¨ $E$ ä¸­çš„æˆå‘˜ç›®æ ‡æ–‡ä»¶ä¼šè¢«ä¸¢æ‰ï¼ˆç”¨ä¸ä¸Šï¼‰ã€‚

è§£æå®Œæˆåï¼Œ$U$ éç©ºï¼Œé“¾æ¥å™¨ä¼šè¾“å‡ºä¸€ä¸ªé”™è¯¯å¹¶ç»ˆæ­¢ã€‚

---

# è§£æé™æ€åº“å¼•ç”¨

Resolving Static Library References

å› ä¸ºä»å·¦åˆ°å³è§£æï¼Œæ‰€ä»¥åœ¨å‘½ä»¤è¡Œé“¾æ¥çš„é¡ºåºå˜å¾—è‡³å…³é‡è¦ã€‚

```bash
gcc foo.c libx.a liby.a libz.a
```

å’Œ

```bash
gcc foo.c libz.a liby.a libx.a
```

ç»“æœä¸ä¸€æ ·ï¼Œå‰è€…ä¼šæŠ¥é”™ï¼Œåè€…ä¸ä¼šã€‚

- `.a` æ–‡ä»¶ä¸­ä¹Ÿå¯èƒ½æœ‰æœªå®šä¹‰çš„ç¬¦å·ï¼Œä¹Ÿå¯èƒ½ä¾èµ–äºå…¶ä»– `.a` æ–‡ä»¶
- åœ¨è§£æè¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ª `.a` æˆ– `.o` æ–‡ä»¶å¯ä»¥å‡ºç°å¤šæ¬¡ã€‚

æ€ä¹ˆåšé¢˜ï¼š**ç”»å‡ºä¾èµ–å›¾ï¼Œæ»¡è¶³æœ€ç»ˆçš„æ¬¡åºèƒ½å¤Ÿéå†æ¯æ¡æœ‰å‘è¾¹ã€‚**

---

# é‡å®šä½

Relocation


**é‡å®šä½èŠ‚**ï¼šå°†æ‰€æœ‰ç›¸åŒç±»å‹çš„èŠ‚åˆå¹¶ä¸ºåŒä¸€ç±»å‹çš„æ–°çš„èšåˆèŠ‚ï¼Œå¹¶æŠŠè¿è¡Œæ—¶å†…å­˜åœ°å€èµ‹ç»™æ–°çš„èšåˆèŠ‚ã€‚è¿™æ ·ï¼Œç¨‹åºä¸­çš„æ¯ä¸€æ¡æŒ‡ä»¤å’Œå…¨å±€å˜é‡éƒ½æœ‰å”¯ä¸€çš„è¿è¡Œæ—¶å†…å­˜åœ°å€äº†ã€‚

**é‡å®šä½ç¬¦å·**ï¼šé“¾æ¥å™¨ä¼šä¿®æ”¹ä»£ç èŠ‚å’Œæ•°æ®èŠ‚ä¸­å¯¹æ¯ä¸ªç¬¦å·çš„å¼•ç”¨ï¼Œä½¿å¾—å®ƒä»¬æŒ‡å‘æ­£ç¡®çš„è¿è¡Œæ—¶å†…å­˜åœ°å€ã€‚è¿™ä¸€æ­¥ä¾èµ–äºå¯é‡å®šä½ç›®æ ‡æ¨¡å—ä¸­çš„ **é‡å®šä½æ¡ç›®**ã€‚

---

# é‡å®šä½æ¡ç›®

Relocation Entries

å½“ **æ±‡ç¼–å™¨** ç”Ÿæˆä¸€ä¸ªç›®æ ‡æ¨¡å—æ—¶ï¼Œå®ƒå¹¶ä¸çŸ¥é“æ•°æ®å’Œä»£ç æœ€ç»ˆå°†æ”¾åœ¨å†…å­˜ä¸­çš„ä»€ä¹ˆä½ç½®ã€‚

æ‰€ä»¥ï¼Œå®ƒå°±ä¼šç”Ÿæˆä¸€ä¸ª**é‡å®šä½æ¡ç›®**ï¼Œå‘Šè¯‰ **é“¾æ¥å™¨** å°†ç›®æ ‡æ–‡ä»¶åˆå¹¶æˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶å¦‚ä½•ä¿®æ”¹è¿™ä¸ªå¼•ç”¨ã€‚

ä»£ç çš„é‡å®šä½æ¡ç›®æ”¾åœ¨ `.rel.text` ä¸­ï¼Œæ•°æ®çš„é‡å®šä½æ¡ç›®æ”¾åœ¨ `.rel.data` ä¸­ã€‚

### ELF é‡å®šä½æ¡ç›®çš„æ ¼å¼

```c
typedef struct {
    long offset;    /* åç§»é‡ï¼šå¼•ç”¨é‡å®šä½çš„åç§»é‡ */
    long type:32;   /* é‡å®šä½ç±»å‹ */
    long symbol:32; /* ç¬¦å·è¡¨ç´¢å¼• */
    long addend;    /* å¸¸é‡éƒ¨åˆ†ï¼šé‡å®šä½è¡¨è¾¾å¼çš„å¸¸é‡éƒ¨åˆ† */
} Elf64_Rela;
```

---

# é‡å®šä½è¿‡ç¨‹

Relocation Process

### é‡å®šä½ç±»å‹{.mb-2}

- `R_X86_64_PC32`ï¼šé‡å®šä½ä¸€ä¸ªä½¿ç”¨ 32 ä½ PC ç›¸å¯¹åœ°å€çš„å¼•ç”¨
- `R_X86_64_32`ï¼šé‡å®šä½ä¸€ä¸ªä½¿ç”¨ 32 ä½ç»å¯¹åœ°å€çš„å¼•ç”¨

ç›¸å¯¹åœ°å€ï¼šè·ç¦» PC çš„**å½“å‰è¿è¡Œæ—¶å€¼**çš„åç§»é‡

---
clicks: 4
---

# é‡å®šä½è¿‡ç¨‹

Relocation Process

<div grid="~ cols-3 gap-4">
<div text-sm relative>

<div :class="$clicks==0 ? 'opacity-100' : 'opacity-0'" transition duration-200 absolute>

å‡è®¾ï¼š

- `ADDR(s)` å’Œ `ADDR(r.symbol)` è¡¨ç¤ºè¿è¡Œæ—¶åœ°å€ï¼Œä¸ä¹‹ç›¸å¯¹çš„ï¼Œ`s` è¡¨ç¤ºå½“å‰è¿˜æ²¡æœ‰é‡å®šä½æ—¶ï¼ŒåŸå§‹ç›®æ ‡æ–‡ä»¶çš„åœ°å€ã€‚
- ç¬¬ 3 è¡Œè®¡ç®—çš„æ˜¯éœ€è¦è¢«é‡å®šä½çš„ 4 å­—èŠ‚å¼•ç”¨çš„æ•°å€¼ $r$ ä¸­çš„åœ°å€ã€‚
- å¦‚æœè¿™ä¸ªå¼•ç”¨ä½¿ç”¨çš„æ˜¯ PC ç›¸å¯¹å¯»å€ï¼Œé‚£ä¹ˆå®ƒå°±ç”¨ç¬¬ 5ï½9 è¡Œæ¥é‡å®šä½ã€‚
- å¦‚æœè¯¥å¼•ç”¨ä½¿ç”¨çš„æ˜¯ç»å¯¹å¯»å€ï¼Œå®ƒå°±é€šè¿‡ç¬¬ 11ï½13 è¡Œæ¥é‡å®šä½ã€‚

</div>

<div :class="$clicks==1 ? 'opacity-100' : 'opacity-0'" transition duration-200 absolute>

`refptr`ï¼šè®¡ç®—ä½ è¦ä¿®æ”¹çš„åœ°å€ï¼ˆåœ¨å“ªé‡Œï¼Œç°åœ¨ç•™ç€çš„æ˜¯ 00ï¼Œæˆ‘ä»¬éœ€è¦å¡«å†™ä¸Šæ­£ç¡®çš„åç§»é‡ / åœ°å€ï¼‰

</div>

<div :class="$clicks==2 ? 'opacity-100' : 'opacity-0'" transition duration-200 absolute>

`refaddr`ï¼šé“¾æ¥åï¼Œå¡«å†™ç›¸å¯¹å€¼çš„åœ°å€

è¿™é‡Œåˆ©ç”¨äº†ï¼šåç§»é‡ï¼ˆ`r.offset`ï¼‰ä¸å˜ã€‚

</div>

<div :class="$clicks==3 ? 'opacity-100' : 'opacity-0'" transition duration-200 absolute>

`r.addend`ï¼šè¡¥å¿ `refaddr` å’Œè¿è¡Œæ—¶ `PC` ä¹‹é—´çš„å·®å€¼

`refaddr = ADDR(PC) + r.addend`

è¿™æ ·ï¼Œæˆ‘ä»¬å°±æœ‰å¦‚ä¸‹å¼å­ï¼š

`PC = refaddr - r.addend`

`PC + *refptr = ADDR(r.symbol)`

è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç›¸å¯¹å®šä½ã€‚

</div>

<div :class="$clicks==4 ? 'opacity-100' : 'opacity-0'" transition duration-200 absolute>

`r.addend`ï¼šå¯¹äºç»å¯¹é‡å®šä½æ¥è®²ï¼Œä¸€èˆ¬å°±è®¾ç½®ä¸º 0 äº†ã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬ç›´æ¥å°±æœ‰ï¼š

`*refptr = ADDR(r.symbol)`

</div>


</div>

<div col-span-2>

```c {all|3|3,7|5-10|12-16}{at:1}
foreach section s {  /* è¿­ä»£èŠ‚ */
    foreach relocation entry r {  /* è¿­ä»£é‡å®šä½æ¡ç›® */
        refptr = s + r.offset;  /* éœ€è¦é‡å®šä½çš„å¼•ç”¨çš„æŒ‡é’ˆï¼Œè¦å†™å“ªé‡Œ */

        /* é‡å®šä½ PC-relative å¼•ç”¨ */
        if (r.type == R_X86_64_PC32) {
            refaddr = ADDR(s) + r.offset;  /* å¼•ç”¨çš„è¿è¡Œæ—¶åœ°å€ */
            /* addend = -4 */
            *refptr = (unsigned) (ADDR(r.symbol) + r.addend - refaddr);
        }

        /* é‡å®šä½ç»å¯¹å¼•ç”¨ */
        if (r.type == R_X86_64_32) {
            /* addend = 0 */
            *refptr = (unsigned) (ADDR(r.symbol) + r.addend); 
        }
    }
}
```

</div>
</div>

---

<div grid="~ cols-2 gap-8">
<div>

# ç›¸å¯¹é‡å®šä½ä¸¾ä¾‹

PC-relative Relocation Example


<div class="text-xs">


```
r.offset = 0xf
r.symbol = sum
r.type = R_X86_64_PC32
r.addend = -4
```

- `r.offset`ï¼š`call` æŒ‡ä»¤ç¬¬äºŒä¸ªå­—èŠ‚ä¸ `main` å‡½æ•°èµ·å§‹åœ°å€çš„åç§»é‡ = `0xf`
- `r.refptr`ï¼šè¦ä¿®æ”¹çš„åœ°å€ï¼Œ`s + r.offset` = `main + 0xf` = `0xf`
- `refaddr`ï¼šå¼•ç”¨çš„è¿è¡Œæ—¶åœ°å€ = `ADDR(s) + r.offset` = `0x4004d0 + 0xf` = `0x4004df`
- `PC`ï¼šè¿è¡Œæ—¶çš„ PCï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ = `0x4004e3`
- `r.addend`ï¼šè¡¥å¿ `refaddr` å’Œè¿è¡Œæ—¶ `PC` ä¹‹é—´çš„å·®å€¼ = `0x4004df - 0x4004e3 = -4`
- `ADDR(r.symbol)`ï¼šçœŸå®è¦å¾—åˆ°çš„åœ°å€ï¼Œä¹Ÿå³ `sum` çš„è¿è¡Œæ—¶åœ°å€ = `0x4004e8`

`*refptr = (unsigned) (ADDR(r.symbol) + r.addend - refaddr) = (unsigned) (0x4004e8 + (-4) - 0x4004df) = 5`

</div>

</div>

<div>

![relocate_relative](./res/image/slides.assets/relocate_relative.png){.mx-auto}

</div>
</div>

---

<div grid="~ cols-2 gap-8">
<div>


# ç»å¯¹é‡å®šä½ä¸¾ä¾‹

Absolute Relocation Example

<div class="text-xs">


```
r.offset = 0xa
r.symbol = array
r.type = R_X86_64_32
r.addend = 0
```

- `r.offset`ï¼š`call` æŒ‡ä»¤ç¬¬äºŒä¸ªå­—èŠ‚ä¸ `main` å‡½æ•°èµ·å§‹åœ°å€çš„åç§»é‡ = `0xa`
- `r.refptr`ï¼šè¦ä¿®æ”¹çš„åœ°å€ï¼Œ`s + r.offset` = `main + 0xa` = `0xa`
- `r.addend`ï¼šå¯¹äºç»å¯¹é‡å®šä½ï¼Œè®¾ç½®ä¸º 0ã€‚
- `ADDR(r.symbol)`ï¼šçœŸå®è¦å¾—åˆ°çš„åœ°å€ï¼Œä¹Ÿå³ `array` çš„è¿è¡Œæ—¶åœ°å€ = `0x601018`

`*refptr = (unsigned) (ADDR(r.symbol) + r.addend) = (unsigned) (0x601018 + 0) = 0x601018`

</div>

</div>

<div>

![relocate_absolute](./res/image/slides.assets/relocate_absolute.png){.mx-auto}

</div>
</div>

---

# å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶

Executable Object File

<div grid="~ cols-2 gap-12">
<div text-sm>


ELF å¤´æè¿°æ–‡ä»¶çš„æ•´ä½“æ ¼å¼ï¼ŒåŒ…å«ç¨‹åºçš„å…¥å£ç‚¹ï¼ˆentry pointï¼‰ï¼Œå³ç¨‹åºè¿è¡Œæ—¶æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ°å€ã€‚

**æ®µ**ï¼šé“¾æ¥å™¨æ ¹æ®ç›®æ ‡æ–‡ä»¶ä¸­ **å±æ€§ç›¸åŒçš„å¤šä¸ªèŠ‚åˆå¹¶åçš„èŠ‚çš„é›†åˆ**{.text-sky-5}ï¼Œè¿™ä¸ªé›†åˆç§°ä¸ºæ®µã€‚

- `.init` æ®µï¼šæ¯”å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶å¤šå‡ºæ¥çš„ï¼ŒåŒ…å«åˆå§‹ä»£ç ï¼ˆ`_init` å‡½æ•°ï¼‰ï¼Œä¼šåœ¨ç¨‹åºå¼€å§‹æ—¶è°ƒç”¨ã€‚
- `.text` `.rodata` `.data` æ®µï¼šä¸åŒåèŠ‚å¯¹åº”ï¼Œå·²è¢«é‡å®šä½åˆ°æœ€ç»ˆçš„è¿è¡Œæ—¶å†…å­˜åœ°å€ã€‚
- `.rel.text` å’Œ `.rel.data` èŠ‚ï¼šä¸å†å­˜åœ¨ï¼Œå› ä¸ºå·²ç»å®Œå…¨é“¾æ¥ã€‚

</div>

<div>

![executable_object_file](./res/image/slides.assets/executable_object_file.png){.mx-auto}

<span class="text-xs text-gray-5">

æ®µä»£è¡¨çš„æ˜¯å¯æ‰§è¡Œä»£ç å’Œæ•°æ®ç­‰å†…å­˜åŒºåŸŸï¼Œè€ŒèŠ‚åˆ™æ›´åŠ æŠ½è±¡ï¼Œå®ƒä»£è¡¨çš„æ˜¯æ–‡ä»¶ä¸­çš„ä¸€ç»„ç›¸å…³æ•°æ®ã€‚åœ¨ ELF æ–‡ä»¶ä¸­ï¼ŒèŠ‚æ˜¯æŒ‰ç…§åŠŸèƒ½å’Œç›®çš„æ¥åˆ’åˆ†çš„ï¼Œæ¯”å¦‚ä»£ç èŠ‚ã€æ•°æ®èŠ‚ã€ç¬¦å·è¡¨èŠ‚ç­‰ç­‰ï¼Œè€Œæ®µåˆ™æ˜¯æŒ‰ç…§å†…å­˜åŒºåŸŸæ¥åˆ’åˆ†çš„ã€‚

</span>

</div>
</div>

---

# åŠ è½½å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶

Loading an Executable Object File

<div grid="~ cols-2 gap-12">
<div>

### å†…å­˜å¸ƒå±€{.mb-2}

- **ä»£ç æ®µ**ï¼šä»åœ°å€ `0x400000` = $2^{21}$ å¼€å§‹ï¼Œåé¢æ˜¯æ•°æ®æ®µ
- **å †å†…å­˜**ï¼šç”± `malloc` åˆ†é…ï¼Œè¿è¡Œæ—¶å †åœ¨æ•°æ®æ®µä¹‹å
- **ç”¨æˆ·æ ˆ**ï¼šä»æœ€å¤§åˆæ³•ç”¨æˆ·åœ°å€ $2^{48} - 1$ å‘ä¸‹å¢é•¿
- **å†…æ ¸åŒº**ï¼šä»åœ°å€ $2^{48}$ å¼€å§‹ï¼Œç”¨äºå†…æ ¸ä»£ç å’Œæ•°æ®æ®µ

`_start`ï¼ˆå…¥å£ç‚¹ï¼‰ â†’ `_libc_start_main`ï¼ˆå®šä¹‰åœ¨ libc.so ä¸­ï¼‰ â†’ `main`

</div>

<div>

![runtime_memory](./res/image/slides.assets/runtime_memory.png){.mx-auto}

</div>
</div>

<!-- 

å®é™…ä¸Šå­˜åœ¨ è™šæ‹Ÿå†…å­˜æ˜ å°„ï¼Œä»¥åŠ ASLRï¼ˆæ¯æ¬¡ç¨‹åºè¿è¡Œæ—¶ï¼Œè¿™äº›åŒºåŸŸçš„**åœ°å€éƒ½ä¼šæ”¹å˜**ï¼Œä½†**ç›¸å¯¹ä½ç½®ä¸å˜**ï¼‰

libc.soï¼šä¸€å®šä¼šè¢«é“¾æ¥ã€‚

-->

---

<div grid="~ cols-2 gap-12">
<div>

# åŠ¨æ€é“¾æ¥å…±äº«åº“

Dynamic Linking Shared Libraries

<div>

å…±äº«åº“ï¼š**åœ¨è¿è¡Œæ—¶è¢«åŠ¨æ€åŠ è½½å’Œé“¾æ¥çš„åº“æ–‡ä»¶**{.text-sky-5}ï¼Œé€šå¸¸ä»¥ `.so`ï¼ˆLinuxï¼‰æˆ– `.dll`ï¼ˆWindowsï¼‰ä¸ºåç¼€ã€‚

- èŠ‚çœèµ„æºï¼šé¿å…é™æ€åº“å¤åˆ¶å¾ˆå¤šæ¬¡
- ç®€åŒ–æ›´æ–°ï¼šæ›´æ–°å…±äº«åº“åªéœ€æ›¿æ¢åº“æ–‡ä»¶ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘æ‰€æœ‰ä¾èµ–çš„ç¨‹åº
- åŠ¨æ€é“¾æ¥ï¼šè¿è¡Œæ—¶åŠ è½½åº“æ–‡ä»¶ï¼Œå¤šä¸ªç¨‹åºå…±äº«åŒä¸€ä»½åº“æ–‡ä»¶

C æ ‡å‡†åº“ `libc.so` é€šå¸¸æ˜¯åŠ¨æ€é“¾æ¥çš„ã€‚

</div>

</div>

<div>

![dynamic_linking](./res/image/slides.assets/dynamic_linking.png){.mx-auto}

</div>
</div>

<!-- 

å›é¡¾é™æ€åº“çš„é“¾æ¥æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å…¶åœ¨é“¾æ¥çš„è¿‡ç¨‹ä¸­ä»åº“ä¸­æå–å‡ºéœ€è¦æ‰§è¡Œçš„ä»£ç å’Œå…¶å®ƒå¯é‡å®šä½æ–‡ä»¶ä¸€èµ·ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚ä½†æ˜¯è¿™æ ·åšä»æœ‰ä¸€äº›ä¸è¶³ä¹‹å¤„ï¼š
1.å¯¹äºä¸€äº›å¾ˆåŸºæœ¬çš„å‡½æ•°ï¼ˆæ¯”å¦‚I/Oæ“ä½œä¸­çš„printf,scanfç­‰ï¼‰ï¼Œåœ¨æ¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„textæ®µä¸­éƒ½ä¼šå­˜åœ¨å…¶çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œè¿™å¯¹äºç£ç›˜ç©ºé—´æ¥è¯´æ˜¯æå¤§çš„æµªè´¹è¡Œä¸ºã€‚
2.å¦‚æœåº“è¿›è¡Œäº†æ›´æ–°æˆ–è€…æ”¹åŠ¨ï¼Œå¿…é¡»é‡æ–°è¿›è¡Œé“¾æ¥è¡Œä¸ºä»¥ç”Ÿæˆæ–°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆè¿™å¯¹ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿæ¥è¯´æ˜¯å¾ˆä¸å‹å¥½çš„ï¼Œå› ä¸ºå…¶æ„å‘³ç€ä¸€ä¸ªå°æ”¹åŠ¨å¯èƒ½ä¼šç‰µæ¶‰åˆ°å¾ˆå¤šæ˜¾å¼æ“ä½œï¼‰

å›å¿†æˆ‘ä»¬ä¹‹å‰çš„é“¾æ¥è¡Œä¸ºï¼Œæˆ‘ä»¬æ€»æ˜¯ä¿®æ”¹ä»£ç å½“ä¸­çš„å…¨å±€å˜é‡å’Œå‡½æ•°çš„åœ°å€ä»è€Œå®Œæˆé‡å®šä½è¡Œä¸ºï¼Œè¿™ç§æ–¹æ³•æ˜¯ä½æ•ˆè€Œâ€œç¬¨é‡â€çš„ï¼šè¿™æ„å‘³ç€åœ¨åŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹ï¼Œæ¯ä¸€æ¬¡å¯¹å…¨å±€å˜é‡å’Œå‡½æ•°åœ°å€çš„æ”¹åŠ¨éƒ½ä¼šç‰µæ¶‰åˆ°å¼•ç”¨å…¶çš„æ‰€æœ‰ä»£ç çš„æ”¹å˜ã€‚æˆ‘ä»¬æ˜¾ç„¶ä¸å¸Œæœ›çœ‹åˆ°è¿™ç§è¡Œä¸ºã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä½ç½®æ— å…³ä»£ç æ¥ä¿è¯å³ä½¿æ˜¯ä½¿ç”¨åŠ¨æ€é“¾æ¥å…±äº«åº“ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šåœ¨è¿è¡Œä¸­æ”¹å˜ä»£ç æ®µ(.text)ï¼ˆåœ¨é™æ€é“¾æ¥çš„è¿‡ç¨‹ä¸­å› ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åªä¼šç”¨åˆ°è‡ªå·±å¤åˆ¶åˆ°å†…å­˜å½“ä¸­çš„ä¸œè¥¿ï¼Œæ‰€ä»¥è¿™ä»¶äº‹æƒ…æ˜¯æ˜¾ç„¶çš„ï¼‰


 -->

---

<div grid="~ cols-2 gap-12">
<div>

# åŠ¨æ€é“¾æ¥å…±äº«åº“

Dynamic Linking Shared Libraries

<div>

#### é“¾æ¥å™¨ã€åŠ è½½å™¨ã€åŠ¨æ€é“¾æ¥å™¨ {.mb-2.mt-4}

- **é“¾æ¥å™¨**ï¼šåœ¨ç¼–è¯‘é˜¶æ®µä¹‹åå·¥ä½œï¼Œå°†å¤šä¸ªç›®æ ‡æ–‡ä»¶å’Œåº“æ–‡ä»¶é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æˆ–åº“æ–‡ä»¶ã€‚
- **åŠ è½½å™¨**ï¼šåœ¨ç¨‹åºæ‰§è¡Œé˜¶æ®µå·¥ä½œï¼Œå°†å¯æ‰§è¡Œæ–‡ä»¶åŠ è½½åˆ°å†…å­˜å¹¶å‡†å¤‡å¥½æ‰§è¡Œç¯å¢ƒã€‚
- **åŠ¨æ€é“¾æ¥å™¨**ï¼šåœ¨åŠ è½½å™¨å°†ç¨‹åºåŠ è½½åˆ°å†…å­˜åã€ç¨‹åºå¼€å§‹æ‰§è¡Œå‰å·¥ä½œï¼Œè´Ÿè´£åœ¨è¿è¡Œæ—¶åŠ è½½åŠ¨æ€åº“å¹¶è§£æç¬¦å·ï¼ˆé‡å®šä½ï¼‰ã€‚

</div>

</div>

<div>

![dynamic_linking](./res/image/slides.assets/dynamic_linking.png){.mx-auto}

</div>
</div>

---
clicks: 1
---

# ä½ç½®æ— å…³ä»£ç 

Position Independent Code

ä½ç½®å›ºå®šï¼šä¼šå¼•èµ·å†…å­˜çš„æµªè´¹ï¼Œæ— æ³•é«˜æ•ˆåˆ©ç”¨ï¼ˆWhy?ï¼‰

<div :class="$clicks>0 ? 'opacity-100' : 'opacity-0'" transition duration-200>

ä½ç½®æ— å…³ï¼šå…±äº«åº“å¯ä»¥è¢«åŠ è½½åˆ°å†…å­˜çš„ä»»ä½•ä½ç½®ï¼Œä»è€Œå¤šä¸ªç¨‹åºå¯ä»¥åŒæ—¶ä½¿ç”¨åŒä¸€ä¸ªå…±äº«åº“å®ä¾‹ï¼ŒèŠ‚çœå†…å­˜ã€‚

<span class="text-sm text-gray-5">

éœ€è¦ä½¿ç”¨ `-fpic` ï¼ˆflag position independent codeï¼‰é€‰é¡¹ç¼–è¯‘å…±äº«åº“

</span>

</div>

---

# è¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆPLTï¼‰ å’Œ å…¨å±€åç§»è¡¨ï¼ˆGOTï¼‰

Procedure Link Table and Global Offset Table, PLT & GOT

å‡è®¾æœ‰ä¸€ä¸ªå…±äº«åº“å‡½æ•° `foo`ï¼Œä»¥ä¸‹æ˜¯è°ƒç”¨è¿‡ç¨‹ï¼š

1. åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ `foo` æ—¶ï¼Œç¨‹åºè·³è½¬åˆ° PLT è¡¨çš„ `foo` å…¥å£
2. PLT è¡¨çš„ `foo` å…¥å£è·³è½¬åˆ° **åŠ¨æ€é“¾æ¥å™¨çš„è§£æå‡½æ•°**{.text-sky-5}
3. åŠ¨æ€é“¾æ¥å™¨è§£æ `foo` çš„åœ°å€ï¼Œå¹¶å°†åœ°å€å†™å…¥ GOT è¡¨ä¸­ç›¸åº”çš„æ¡ç›®
4. åŠ¨æ€é“¾æ¥å™¨è¿”å›ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œ `foo` å‡½æ•°
5. ä¸‹ä¸€æ¬¡è°ƒç”¨ `foo` æ—¶ï¼ŒPLT è¡¨ç›´æ¥ä» GOT è¡¨ä¸­è¯»å– `foo` çš„åœ°å€å¹¶è·³è½¬ï¼Œ**æ— éœ€å†æ¬¡è§£æ**{.text-sky-5}

<!-- 

å¦‚æœä»£ç ä½ç½®æ˜¯å›ºå®šçš„ï¼Œé‚£ä¹ˆæ¯ä¸ªç¨‹åºæˆ–åº“éƒ½éœ€è¦åœ¨ç‰¹å®šçš„å†…å­˜åœ°å€æ‰§è¡Œã€‚è¿™ä¼šå¯¼è‡´å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿå’Œæµªè´¹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºéœ€è¦å ç”¨ç‰¹å®šçš„å†…å­˜åŒºåŸŸï¼Œé‚£ä¹ˆåœ¨è¯¥åŒºåŸŸå†…çš„å…¶ä»–å†…å­˜ç©ºé—´å¯èƒ½ä¼šè¢«æµªè´¹æ‰ã€‚ä½ç½®æ— å…³ä»£ç å…è®¸ç¨‹åºå’Œåº“åœ¨å†…å­˜ä¸­çš„ä»»æ„ä½ç½®åŠ è½½å’Œæ‰§è¡Œï¼Œä»è€Œæ›´é«˜æ•ˆåœ°åˆ©ç”¨å†…å­˜ç©ºé—´ã€‚

 -->

---
clicks: 8
---

# PLT å’Œ GOT ä¸¾ä¾‹

PLT & GOT Example

<div grid="~ cols-2 gap-12">
<div>

```asm{all|1,2|1,2|1,2,7|1,2,7|1,2,7|1,2,4,7|1,2,4-5,7}{at:1}
# æ•°æ®æ®µ
# å…¨å±€åç§»é‡è¡¨ (GOT)
GOT[0]: addr of .dynamic
GOT[1]: addr of reloc entries # é‡å®šä½æ¡ç›®çš„åœ°å€
GOT[2]: addr of dynamic linker # åŠ¨æ€é“¾æ¥å™¨çš„åœ°å€
GOT[3]: 0x4005b6 # sys startup
GOT[4]: 0x4005c6 # addvec()
GOT[5]: 0x4005d6 # printf()
```

```asm
# ä»£ç æ®µ
callq 0x4005c0 # call addvec()
```

```asm{all|1|6-7|6-7|6-8|6-9|1-3,6-9|1-4,6-9}{at:1}
# è¿‡ç¨‹é“¾æ¥è¡¨ (PLT)
# PLT[0]: call dynamic linker
4005a0: pushq *GOT[1]
4005a6: jmpq *GOT[2]
...
# PLT[2]: call addvec()
4005c0: jmpq *GOT[4]
4005c6: pushq $0x1 # addvec çš„ ID
4005cb: jmpq 4005a0
```

</div>

<div v-click="8">

```asm{1-2,7}
# æ•°æ®æ®µ
# å…¨å±€åç§»é‡è¡¨ (GOT)
GOT[0]: addr of .dynamic
GOT[1]: addr of reloc entries
GOT[2]: addr of dynamic linker
GOT[3]: 0x4005b6 # sys startup
GOT[4]: &addvec()
GOT[5]: 0x4005d6 # printf()
```

```asm
# ä»£ç æ®µ
callq 0x4005c0 # call addvec()
```

```asm{1,6-7}
# è¿‡ç¨‹é“¾æ¥è¡¨ (PLT)
# PLT[0]: call dynamic linker
4005a0: pushq *GOT[1]
4005a6: jmpq *GOT[2]
...
# PLT[2]: call addvec()
4005c0: jmpq *GOT[4]
4005c6: pushq $0x1
4005cb: jmpq 4005a0
```

</div>
</div>


---

# åº“æ‰“æ¡©æœºåˆ¶

Library Interposition

**æ‰“æ¡©**ï¼šåœ¨è¿è¡Œæ—¶æ›¿æ¢åº“å‡½æ•°çš„è¡Œä¸ºã€‚

æ‰“æ¡©æœºåˆ¶æœ‰ä¸‰ç§ä¸»è¦æ–¹æ³•ï¼š
- ç¼–è¯‘æ—¶æ‰“æ¡©
- é“¾æ¥æ—¶æ‰“æ¡©
- è¿è¡Œæ—¶æ‰“æ¡©

---

# ç¼–è¯‘æ—¶æ‰“æ¡©

Compile-Time Interposition

**æ¦‚å¿µ**ï¼šé€šè¿‡åœ¨ç¼–è¯‘æºä»£ç æ—¶æ’å…¥æ‰“æ¡©å‡½æ•°æ¥å®ç°ã€‚

**å®ç°æ–¹å¼**ï¼šä½¿ç”¨ `-D` ç¼–è¯‘é€‰é¡¹å°†æ ‡å‡†å‡½æ•°æ›¿æ¢ä¸ºè‡ªå®šä¹‰å‡½æ•°ã€‚

ç¼–è¯‘å‘½ä»¤ï¼š
```sh
gcc -I.-o intc int.c mymalloc.o
```

- `-I.`ï¼šå‘Šè¯‰ç¼–è¯‘å™¨åœ¨å½“å‰ç›®å½•ï¼ˆ`.`ï¼‰ä¸­æŸ¥æ‰¾å¤´æ–‡ä»¶ï¼ˆIncludeï¼‰
- `-o intc`ï¼šæŒ‡å®šè¾“å‡ºæ–‡ä»¶åä¸º `intc`
- `int.c`ï¼šæºæ–‡ä»¶
- `mymalloc.o`ï¼šè‡ªå®šä¹‰åŠ¨æ€åº“

è¿™æ ·åšåï¼Œä¼šåœ¨æœç´¢ `malloc` æ—¶ï¼Œä¼˜å…ˆæœç´¢ `mymalloc.o` ä¸­çš„ `malloc`ï¼Œç„¶åå†æœç´¢é€šå¸¸çš„ç³»ç»Ÿç›®å½•ã€‚

---



# é“¾æ¥æ—¶æ‰“æ¡©

Link-Time Interposition

<div grid="~ cols-2 gap-4">
<div class="children-[p]-mt-0">


**æ¦‚å¿µ**ï¼šåœ¨é“¾æ¥é˜¶æ®µï¼Œç”¨è‡ªå®šä¹‰å‡½æ•°æ›¿æ¢æ ‡å‡†åº“å‡½æ•°ã€‚

**å®ç°æ–¹å¼**ï¼šä½¿ç”¨ `--wrap` é€‰é¡¹å‘Šè¯‰é“¾æ¥å™¨ç”¨è‡ªå®šä¹‰å‡½æ•°æ›¿æ¢æ ‡å‡†å‡½æ•°ã€‚

é“¾æ¥å‘½ä»¤ï¼š
```sh
gcc -c mymalloc.c # -c åªç¼–è¯‘ï¼Œä¸é“¾æ¥ï¼Œå¾—åˆ° mymalloc.o
gcc -c int.c # å¾—åˆ° int.o
# -Wlï¼šå°†åé¢çš„é€‰é¡¹ä¼ é€’ç»™é“¾æ¥å™¨ ldã€‚
gcc -Wl,--wrap,malloc \
    -Wl,--wrap,free \
    -o intl int.o mymalloc.o # é“¾æ¥æ—¶æ‰“æ¡©
```


</div>

<div>



```c
// mymalloc.c
void *__real_malloc(size_t size);
void *__wrap_malloc(size_t size) {
    void *ptr = __real_malloc(size); // è°ƒç”¨åŸå§‹malloc
    printf("malloc(%zu) = %p\n", size, ptr);
    return ptr;
}
...

// int.c
#include <stdio.h>
#include <malloc.h>
int main(){
    int *p = malloc(32);
    free(p);
    return(0);
}
```

</div>
</div>

---

# è¿è¡Œæ—¶æ‰“æ¡©

Runtime Interposition

**æ¦‚å¿µ**ï¼šåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼ŒåŠ¨æ€æ›¿æ¢åº“å‡½æ•°ã€‚

**å®ç°æ–¹å¼**ï¼šä½¿ç”¨ `LD_PRELOAD` ç¯å¢ƒå˜é‡åŠ è½½è‡ªå®šä¹‰åŠ¨æ€åº“ã€‚

```sh
gcc -shared -fpic -o mymalloc.so mymalloc.c -ldl
LD_PRELOAD="./mymalloc.so" ./myprogram
```

- `-shared`ï¼šç”Ÿæˆå…±äº«åº“
- `-fpic`ï¼šç”Ÿæˆä½ç½®æ— å…³ä»£ç ï¼Œ**è¿™æ˜¯å…±äº«åº“æ‰€å¿…éœ€çš„ï¼Œå› ä¸ºå…±äº«åº“å¯ä»¥åŠ è½½åˆ°å†…å­˜ä¸­çš„ä»»ä½•ä½ç½®**{.text-sky-5}
- `-ldl`ï¼šé“¾æ¥åŠ¨æ€é“¾æ¥å™¨åº“ï¼Œ`libdl` æ˜¯åŠ¨æ€é“¾æ¥å™¨åº“
- `LD_PRELOAD`ï¼šç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®šåœ¨è¿è¡Œç¨‹åºæ—¶åŠ è½½çš„è‡ªå®šä¹‰åŠ¨æ€åº“



---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Emphasis
</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>

---

# ç¼–è¯‘æµç¨‹

![å›¾ç‰‡2](./res/image/slides.assets/å›¾ç‰‡2.png)

é¢„å¤„ç†å™¨`cpp` $\rightarrow$ ç¼–è¯‘å™¨`ccl` $\rightarrow$ æ±‡ç¼–å™¨`as`  $\rightarrow$ é“¾æ¥`ld` $\rightarrow$ åŠ è½½å™¨`loader`

---

# æ–‡ä»¶ç¬¦å·

- **æºæ–‡ä»¶ï¼ˆ.cï¼‰**ï¼šåŒ…å«äººç±»å¯è¯»çš„æºä»£ç ã€‚
- **é¢„å¤„ç†æ–‡ä»¶ï¼ˆ.iï¼‰**ï¼šåŒ…å«å±•å¼€çš„å®å’Œå¤´æ–‡ä»¶å†…å®¹ï¼ˆé€šè¿‡é¢„å¤„ç†ç”Ÿæˆï¼‰ã€‚
- **æ±‡ç¼–æ–‡ä»¶ï¼ˆ.sï¼‰**ï¼šC æ–‡ä»¶ç¼–è¯‘åçš„æ±‡ç¼–ä»£ç ï¼ˆé€šè¿‡ç¼–è¯‘ç”Ÿæˆï¼‰ã€‚
- **ç›®æ ‡æ–‡ä»¶ï¼ˆ.oï¼‰**ï¼šæ±‡ç¼–æ–‡ä»¶æˆ– C æ–‡ä»¶ç¼–è¯‘åçš„æœºå™¨ä»£ç ï¼ŒåŒ…å«ç¬¦å·è¡¨å’Œé‡å®šä½ä¿¡æ¯ã€‚
- **é™æ€åº“æ–‡ä»¶ï¼ˆ.aï¼‰**ï¼šåŒ…å«å¤šä¸ª `.o` æ–‡ä»¶çš„å½’æ¡£æ–‡ä»¶ï¼Œç”¨äºé™æ€é“¾æ¥ã€‚
- **å…±äº«åº“æ–‡ä»¶ï¼ˆ.soï¼‰**ï¼šåŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ï¼Œç¨‹åºè¿è¡Œæ—¶åŠ è½½ã€‚
- **å¯æ‰§è¡Œæ–‡ä»¶**ï¼šæœ€ç»ˆçš„å¯æ‰§è¡Œç¨‹åºï¼ŒåŒ…å«æ‰€æœ‰å·²è§£æçš„ç¬¦å·å’Œé‡å®šä½çš„ä»£ç ã€‚

**.c -> .o -> .a / .so -> å¯æ‰§è¡Œæ–‡ä»¶** æ˜¯ä¸€ä¸ªå¸¸è§çš„ç¼–è¯‘-é“¾æ¥-æ‰§è¡Œçš„å®Œæ•´æµç¨‹

---



# åŸºæœ¬æ¦‚å¿µ

- å¼•ç”¨ï¼šåœ¨ .text ï¼ˆä»£ç æ®µï¼‰çš„ä»»ä½•åœ°æ–¹å–å€¼æˆ–å–åœ°å€

- å£°æ˜ï¼š`(static/extern) type name ... ;`

- å®šä¹‰ï¼š`(static) type name ... ;`

  ![image-20240106001444312](./res/image/slides.assets/image-20240106001444312.png)

---



# ç›®æ ‡æ–‡ä»¶

- æ ¼å¼

  - Mac OS-X: Mach-O
  - Windows: PE
  - Linux: **ELF**

  ![image-20240105235901077](./res/image/slides.assets/image-20240105235901077.png)

---



# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

#### ELF

![image-20240105221654372](./res/image/slides.assets/image-20240105221654372.png)

---



# ç¬¦å·å’Œç¬¦å·è¡¨

- `.symtab`ï¼šä¸€ä¸ªç¬¦å·è¡¨ï¼Œå®ƒå­˜æ”¾åœ¨ç¨‹åºä¸­**å®šä¹‰**å’Œ**å¼•ç”¨**çš„å‡½æ•°å’Œå…¨å±€å˜é‡çš„ä¿¡æ¯

![image-20240106000629759](./res/image/slides.assets/image-20240106000629759.png)

---



# ç¤ºä¾‹

![image-20240106001641991](./res/image/slides.assets/image-20240106001641991.png)

---



# ä¼ªèŠ‚

- ä¼ªèŠ‚åªå­˜åœ¨äºå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œä¸å­˜åœ¨äºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­
- `ABS`ï¼šä¸è¯¥è¢«é‡å®šä½çš„ç¬¦å·
- `UNDEF`ï¼šæœªå®šä¹‰çš„ç¬¦å·ï¼ˆåªæœ‰å¼•ç”¨ï¼‰
- `COMMON`ï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ˆé€‚é…ç¬¦å·è§£æè§„åˆ™ï¼‰
  - åˆå§‹åŒ–ä¸º 0 çš„å…¨å±€å˜é‡ä¸æ‰€æœ‰é™æ€å˜é‡å­˜æ”¾äº .bss ä¸­
  - åœ¨å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­ COMMON ä¿å­˜çš„æ•°æ®ä¼šè¿›å…¥ .bss

![PixPin_2024-11-13_11-02-30](./res/image/slides.assets/PixPin_2024-11-13_11-02-30.png)

---



# å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶

## ELF

![image-20240105235922818](./res/image/slides.assets/image-20240105235922818.png)

---



# ç¨‹åºå¤´éƒ¨è¡¨ï¼ˆæ®µå¤´éƒ¨è¡¨ï¼‰

![image-20240106003916489](./res/image/slides.assets/image-20240106003916489.png)

---



# åŠ è½½

- `loader -> _start() -> __libc_start_main() -> main()`

![image-20240106003905722](./res/image/slides.assets/image-20240106003905722.png)

# å…±äº«ç›®æ ‡æ–‡ä»¶

---

| ç‰¹æ€§               | å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼ˆ.oï¼‰             | å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ï¼ˆæ— ç‰¹å®šåç¼€æˆ– .exeï¼‰ | å…±äº«ç›®æ ‡æ–‡ä»¶ï¼ˆ.so / .dllï¼‰     |
| ------------------ | ---------------------------------- | ----------------------------------- | ------------------------------ |
| **æ–‡ä»¶ç”Ÿæˆé˜¶æ®µ**   | ç¼–è¯‘é˜¶æ®µ                           | é“¾æ¥é˜¶æ®µ                            | åŠ¨æ€é“¾æ¥åº“ç”Ÿæˆ                 |
| **æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œ** | å¦ï¼Œéœ€è¿›ä¸€æ­¥é“¾æ¥                   | æ˜¯ï¼Œå¯ç›´æ¥åŠ è½½å¹¶è¿è¡Œ                | å¦ï¼Œéœ€åŠ¨æ€é“¾æ¥åˆ°è¿›ç¨‹ä¸­         |
| **åœ°å€ç±»å‹**       | ç›¸å¯¹åœ°å€ï¼ˆéœ€é‡å®šä½ï¼‰               | ç»å¯¹åœ°å€                            | å¯ç›¸å¯¹ä¹Ÿå¯å»¶è¿Ÿè§£æ             |
| **ä¸»è¦å†…å®¹**       | ä»£ç æ®µã€æ•°æ®æ®µã€ç¬¦å·è¡¨ã€é‡å®šä½ä¿¡æ¯ | ä»£ç æ®µã€æ•°æ®æ®µã€å…¥å£åœ°å€            | ä»£ç æ®µã€æ•°æ®æ®µã€åŠ¨æ€æ®µã€ç¬¦å·è¡¨ |
| **åº”ç”¨åœºæ™¯**       | é“¾æ¥è¾“å…¥æ–‡ä»¶ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–åº“   | å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç¨‹åºå…¥å£ç”±ç³»ç»ŸåŠ è½½      | å…±äº«åº“ï¼Œåœ¨å¤šä¸ªç¨‹åºä¸­å…±äº«ä½¿ç”¨   |
| **é“¾æ¥æ–¹å¼**       | é™æ€é“¾æ¥                           | é™æ€æˆ–åŠ¨æ€é“¾æ¥                      | åŠ¨æ€é“¾æ¥                       |
| **é‡å®šä½éœ€æ±‚**     | éœ€è¦åœ¨é“¾æ¥æ—¶é‡å®šä½                 | å·²é‡å®šä½å®Œæˆ                        | åŠ è½½æ—¶åŠ¨æ€é‡å®šä½               |
| **å…±äº«æ€§**         | ç‹¬ç«‹ï¼Œä¸å…±äº«                       | ç‹¬ç«‹ï¼Œä¸å…±äº«                        | æ”¯æŒå¤šä¸ªè¿›ç¨‹å…±äº«               |

---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

#### æ–‡ä»¶ç±»å‹

- **æ–‡ä»¶åç¼€**ï¼šé€šå¸¸ä»¥ `.o`ï¼ˆUnix/Linuxï¼‰ã€`.obj`ï¼ˆWindowsï¼‰ä¸ºåç¼€ã€‚

- **ç”Ÿæˆæ–¹å¼**ï¼šé€šè¿‡ç¼–è¯‘æºæ–‡ä»¶ç”Ÿæˆã€‚ä¾‹å¦‚ï¼š

  ```bash
  gcc -c example.c -o example.o
  ```

- **ç¤ºä¾‹**ï¼šå‡è®¾æœ‰æ–‡ä»¶ `example.c`ï¼Œå°†å…¶ç¼–è¯‘ä¸º `example.o`ï¼Œå¾—åˆ°çš„å°±æ˜¯ä¸€ä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ã€‚

#### å†…å®¹

å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

- **ä»£ç æ®µ**ï¼šå¦‚ `.text` æ®µï¼ŒåŒ…å«ç¼–è¯‘ç”Ÿæˆçš„æœºå™¨æŒ‡ä»¤ã€‚
- **æ•°æ®æ®µ**ï¼šå¦‚ `.data`ï¼ˆå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼‰å’Œ `.bss`ï¼ˆæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼‰æ®µã€‚
- **ç¬¦å·è¡¨**ï¼šåˆ—å‡ºæ–‡ä»¶ä¸­çš„ç¬¦å·ï¼ˆå‡½æ•°ã€å˜é‡ç­‰ï¼‰å®šä¹‰å’Œå¼•ç”¨ã€‚
- **é‡å®šä½ä¿¡æ¯**ï¼šæ ‡è¯†å‡ºéœ€è¦åœ¨é“¾æ¥é˜¶æ®µè°ƒæ•´çš„åœ°å€ã€‚



---

# å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶

#### æ–‡ä»¶ç±»å‹

- **æ–‡ä»¶åç¼€**ï¼šåœ¨ Unix/Linux ç³»ç»Ÿä¸Šæ²¡æœ‰ç‰¹å®šåç¼€ï¼Œä¸€èˆ¬å‘½åä¸º `a.out` æˆ–ç›´æ¥ä»¥ç¨‹åºåç§°å‘½åï¼›åœ¨ Windows ç³»ç»Ÿä¸Šé€šå¸¸ä»¥ `.exe` ä½œä¸ºåç¼€ã€‚

- **ç”Ÿæˆæ–¹å¼**ï¼šé€šè¿‡é“¾æ¥å™¨å°†å¤šä¸ª `.o` æ–‡ä»¶ç»„åˆå¹¶é‡å®šä½ç”Ÿæˆã€‚ä¾‹å¦‚ï¼š

  ```bash
  gcc main.o example.o -o example_program
  ```

- **ç¤ºä¾‹**ï¼šè¿è¡Œ `gcc main.o example.o -o example_program` åç”Ÿæˆçš„ `example_program` å°±æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ã€‚

#### å†…å®¹

å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

- **ä»£ç æ®µ**ï¼šåŒ…å«ç¨‹åºçš„æŒ‡ä»¤ï¼Œè®¾ç½®ä¸ºå¯æ‰§è¡Œã€‚
- **æ•°æ®æ®µ**ï¼šåŒ…å«ç¨‹åºçš„æ•°æ®ï¼Œå·²å®Œæˆé‡å®šä½ã€‚
- **ç¨‹åºå…¥å£**ï¼šæŒ‡æ˜ç¨‹åºå¼€å§‹æ‰§è¡Œçš„å…¥å£åœ°å€ã€‚
- **åŠ¨æ€é“¾æ¥ä¿¡æ¯**ï¼ˆè‹¥ä¸ºåŠ¨æ€é“¾æ¥ï¼‰ï¼šåŒ…å«å¯¹å…±äº«åº“çš„ä¾èµ–ä¿¡æ¯ã€‚



---



# å…±äº«ç›®æ ‡æ–‡ä»¶

#### æ–‡ä»¶ç±»å‹

- **æ–‡ä»¶åç¼€**ï¼šåœ¨ Unix/Linux ç³»ç»Ÿä¸Šä»¥ `.so` ä¸ºåç¼€ï¼Œåœ¨ Windows ç³»ç»Ÿä¸Šä»¥ `.dll` ä¸ºåç¼€ã€‚

- **ç”Ÿæˆæ–¹å¼**ï¼šé€šè¿‡ç¼–è¯‘å™¨æˆ–é“¾æ¥å™¨æŒ‡å®šç”Ÿæˆå…±äº«åº“ã€‚ä¾‹å¦‚ï¼š

  ```
  bash
  
  
  å¤åˆ¶ä»£ç 
  gcc -shared -fPIC example.c -o libexample.so
  ```

- **ç¤ºä¾‹**ï¼šè¿è¡Œ `gcc -shared -fPIC example.c -o libexample.so` åç”Ÿæˆçš„ `libexample.so` å°±æ˜¯ä¸€ä¸ªå…±äº«ç›®æ ‡æ–‡ä»¶ã€‚

#### å†…å®¹

å…±äº«ç›®æ ‡æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

- **ä»£ç æ®µ**ï¼šåŒ…å«å…±äº«åº“çš„ä»£ç ï¼Œå¯ä»¥è¢«å¤šä¸ªç¨‹åºåŠ è½½å¹¶å…±äº«ã€‚
- **æ•°æ®æ®µ**ï¼šåŒ…å«å…±äº«åº“çš„å…¨å±€æ•°æ®ã€‚
- **åŠ¨æ€æ®µ**ï¼šè®°å½•å…±äº«åº“çš„ä¾èµ–å’Œç¬¦å·è¡¨ï¼Œç”¨äºåŠ¨æ€é“¾æ¥æ—¶ç¬¦å·è§£æã€‚
- **å…¨å±€åç§»è¡¨ï¼ˆGOTï¼‰å’Œè¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆPLTï¼‰**ï¼šç”¨äºå»¶è¿Ÿç»‘å®šçš„ç¬¦å·è§£ææœºåˆ¶ã€‚

---



# é™æ€é“¾æ¥

# ç¬¦å·è§£æ

> å°†æ¯ä¸ªç¬¦å·å¼•ç”¨æ­£å¥½å’Œä¸€ä¸ªç¬¦å·å®šä¹‰å…³è”èµ·æ¥

![image-20240106001547877](./res/image/slides.assets/image-20240106001547877.png)

- æ³¨ï¼šå¼ºå¼±ä»…é’ˆå¯¹å…¨å±€ç¬¦å·çš„å®šä¹‰ï¼Œæœ¬åœ°ç¬¦å·ï¼ˆstaticï¼‰ã€å‡½æ•°å¼•ç”¨ã€éé™æ€å±€éƒ¨å˜é‡å‡ä¸å‚ä¸å¼ºå¼±è®¨è®º

![image-20240106001601768](./res/image/slides.assets/image-20240106001601768.png)

# é‡å®šä½

> åˆ©ç”¨é‡å®šä½æ¡ç›®ï¼ŒæŠŠæ¯ä¸€ä¸ªç¬¦å·å®šä¹‰ä¸ä¸€ä¸ªå†…å­˜ä½ç½®å…³è”èµ·æ¥

![image-20240106000816011](./res/image/slides.assets/image-20240106000816011.png)

![image-20240106000925294](./res/image/slides.assets/image-20240106000925294.png)

![image-20240106000937366](./res/image/slides.assets/image-20240106000937366.png)

- é‡å®šä½å¼•ç”¨åœ°å€`refaddr`ï¼šæŒ‡`ADDR(s) + r.offset`
- é‡å®šä½å¼•ç”¨å€¼`*refptr`ï¼šæŒ‡32ä½æ•°å€¼`0x0000XXXX`



1. ä¾æ®é‡å®šä½æ¡ç›®ï¼Œå¾—çŸ¥`r.offset`ï¼Œ`r.symbol`ï¼Œ`r.type`ï¼Œ`r.addend=-4/0`

2. ä¾æ®é“¾æ¥å™¨ï¼Œå¾—çŸ¥`ADDR(s)`ï¼Œ`ADDR(r.symbol)`

3. æ±‚å¾—`*refptr`å³æŒ‡ä»¤ä¸­ç¼–ç çš„32ä½å€¼

   1. `r.type == R_X86_64_32`ç»å¯¹å¼•ç”¨

      `*refptr = ADDR(r.symbol)`

   2. `r.type == R_X86_64_PC32`ç›¸å¯¹å¼•ç”¨

      - `*refptr = ADDR(r.symbol) - PC`
      - `PC = ADDR(s) + r.offset - r.addend`

# å…±äº«åº“

# é™æ€åº“é“¾æ¥

![image-20240106002218002](./res/image/slides.assets/image-20240106002218002.png)

---

# é™æ€åº“é“¾æ¥

![image-20240106004108713](./res/image/slides.assets/image-20240106004108713.png)

- æ³¨æ„ï¼š .o ä¸ .a çš„ä¸åŒ
  - **.o åœ¨é“¾æ¥ç®—æ³•ä¸­ä¼šç›´æ¥é‡å®šä½åŠ å…¥æ±‡ç¼–è€Œ .a åªä¼šåŠ å…¥å…¶è¢«å¼•ç”¨çš„ç¬¦å·**



---



# åŠ¨æ€åº“é“¾æ¥

![image-20240106004133587](./res/image/slides.assets/image-20240106004133587.png)

---



# ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰

![image-20240106004209297](./res/image/slides.assets/image-20240106004209297.png)

---

# GOT

![image-20240106004327288](./res/image/slides.assets/image-20240106004327288.png)

---

# PLT

![image-20240106004418727](./res/image/slides.assets/image-20240106004418727.png)


---

åŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. **åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«åº“**ï¼Œå¹¶å¯åŠ¨åŠ¨æ€é“¾æ¥å™¨ã€‚
2. **è§£æä¾èµ–å…³ç³»**ï¼ŒåŠ è½½æ‰€æœ‰ä¾èµ–çš„å…±äº«åº“ã€‚
3. **å‡†å¤‡ GOT å’Œ PLT** è¡¨ï¼Œç¡®ä¿ç¬¦å·å¯ä»¥è¢«åŠ¨æ€è§£æã€‚
4. **ç¬¦å·è§£æå’Œé‡å®šä½**ï¼Œåœ¨åˆæ¬¡åŠ è½½æ—¶å®Œæˆå¤§éƒ¨åˆ†ç¬¦å·çš„è§£æã€‚
5. **å»¶è¿Ÿç»‘å®š**ï¼Œå½“ç¬¬ä¸€æ¬¡è°ƒç”¨å…±äº«åº“çš„å‡½æ•°æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨è§£æç¬¦å·å¹¶ç»‘å®šã€‚
6. **å®Œæˆåˆå§‹åŒ–å¹¶è·³è½¬åˆ°å…¥å£ç‚¹**ï¼Œç¨‹åºå¼€å§‹æ­£å¸¸æ‰§è¡Œã€‚



---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Part1
</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>


---

# col2

<div grid="~ cols-2 gap-2">

<div>


</div>

<div>


</div>
</div>



---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Part2
</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>


---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Part3
</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>

---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Homework Review</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>



---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Exercises</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>


---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Notices</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>


---
layout: center
---

<div flex="~ gap-20"  mt-2 justify-center items-center>

<div  w-fit h-fit mb-2>

# THANKS

Made by WalkerCH 

changxinhai@stu.pku.edu.cn

<p class="text-gray-40">
  <font size = '3'>
    Reference: [Weicheng Lin]'s presentation.<br>
    Reference: [Arthals]'s templates and content.
  </font>
</p>

</div>

![wechat](./res/image/slides.assets/wechat.jpg){.w-50.rounded-md}

</div>
